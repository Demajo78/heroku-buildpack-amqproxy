#!/usr/bin/env bash

set -eo pipefail

indent() {
  sed -u 's/^/       /'
}

mktmpdir() {
  dir=$(mktemp -t fakesu-$1-XXXX)
  rm -rf $dir
  mkdir -p $dir
  echo $dir
}

# Usage: $ set-env key value
set-env() {
  echo "export $1=$2"
}

BUILD_DIR=$1
CACHE_DIR=$2
AMQPROXY_URL="https://github.com/cloudamqp/amqproxy/releases/download/v0.4.0/amqproxy-0.4.0-1.linux-x86_64-static.tar.gz"
AMQPROXY_FILE="amqproxy-0.4.0-1.linux-x86_64-static"
AMQPROXY_VERSION="0.4.0"
INSTALL_DIR="$BUILD_DIR/vendor/"


mkdir -p $INSTALL_DIR
mkdir -p $CACHE_DIR


echo "Fetching and unpacking amqproxy" | indent
curl -OL $AMQPROXY_URL
tar xvf "$AMQPROXY_FILE".tar.gz -C $BUILD_DIR/vendor/
chmod +x $BUILD_DIR/vendor/amqproxy

set-env PATH '/app/vendor/amqproxy/:$PATH'

echo "Done" | indent